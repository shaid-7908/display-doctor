<div class="card form-card">
  <div class="card-header bg-white">
    <h5 class="mb-0">
      <i class="fas fa-list me-2 text-primary"></i>Filtered TV Issues
      <span class="badge bg-primary ms-2"><%= pagination.totalIssues %></span>
    </h5>
  </div>
  <div class="card-body p-0">
    <% if (issues.length === 0) { %>
    <div class="text-center py-5">
      <i class="fas fa-tv fa-3x text-muted mb-3"></i>
      <h5 class="text-muted">No TV Issues Found</h5>
    </div>
    <% } else { %>
    <div class="table-responsive">
      <table class="table table-hover mb-0">
        <thead class="table-light">
          <tr>
            <th>Code</th>
            <th>Issue</th>
            <th>Customer</th>
            <th>TV</th>
            <th>Status</th>
            <th>Created</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <% issues.forEach(issue => { const c = issue.customer_info; %>
          <tr>
            <td>
              <span class="badge bg-secondary"><%= issue.issue_code %></span>
            </td>
            <td>
              <%= issue.issue_name %><br />
              <small class="text-muted"><%= issue.issue_description %></small>
            </td>
            <td>
              <strong><%= c.customer_name %></strong><br />
              <small class="text-muted">
                <% if (c.customer_phone) { %>
                <i class="fas fa-phone me-1"></i> <%= c.customer_phone %><br />
                <% } %> <% if (c.customer_city || c.customer_state) { %>
                <i class="fas fa-map-marker-alt me-1"></i>
                <%= c.customer_city || '' %>, <%= c.customer_state || '' %> <% }
                %>
              </small>
            </td>
            <td><%= issue.tv_model || '' %></td>
            <td>
              <% let statusClass = ""; %> <% switch(issue.issue_status) { case
              "open": statusClass = "bg-primary"; break; case "in_progress":
              statusClass = "bg-warning text-dark"; break; case "resolved":
              statusClass = "bg-success"; break; case "rejected_after_visit":
              statusClass = "bg-danger"; break; case "visit_scheduled":
              statusClass = "bg-info"; break; case "closed": statusClass =
              "bg-secondary"; break; case "rejected": statusClass = "bg-dark";
              break; default: statusClass = "bg-light text-dark"; break; } %>
              <span class="badge <%= statusClass %>">
                <%= issue.issue_status.replace(/_/g, ' ') %>
              </span>
            </td>
            <td><%= new Date(issue.created_at).toLocaleDateString() %></td>
            <td class="d-flex flex-wrap gap-1">
                <a
                  href="/caller/issue-details/<%= issue._id %>"
                  class="btn btn-sm btn-outline-primary"
                >
                  View
                </a>
                <button
                  type="button"
                  class="btn btn-sm btn-warning update-status-btn"
                  data-issue-id="<%= issue._id %>"
                  data-current-status="<%= issue.issue_status %>"
                  data-bs-toggle="modal"
                  data-bs-target="#updateStatusModal"
                >
                  Update Status
                </button>
              </td>
              
          </tr>
          <% }) %>
        </tbody>
      </table>
    </div>
    <% } %>
  </div>
</div>

<!-- Update Status Modal -->
<div class="modal fade" id="updateStatusModal" tabindex="-1" aria-labelledby="updateStatusModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <form id="statusUpdateForm" method="POST" action="/caller/update-status">
        <input type="hidden" name="issue_id" id="modalIssueId" />
  
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="updateStatusModalLabel">
              <i class="fas fa-sync-alt me-2"></i>Update Issue Status
            </h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <div class="mb-3">
              <label for="newStatus" class="form-label">New Status</label>
              <select class="form-select" name="new_status" id="newStatus" required>
                <option value="">-- Select Status --</option>
                <option value="open">Open</option>
                <option value="in_progress">In Progress</option>
                <option value="visit_scheduled">Visit Scheduled</option>
                <option value="resolved">Resolved</option>
                <option value="rejected_after_visit">Rejected After Visit</option>
                <option value="closed">Closed</option>
                <option value="rejected">Rejected</option>
              </select>
            </div>
            <div class="mb-3">
              <label for="statusComment" class="form-label">Comment (optional)</label>
              <textarea class="form-control" name="comment" id="statusComment" rows="3"></textarea>
            </div>
          </div>
          <div class="modal-footer">
            <button type="submit" class="btn btn-primary">
              <i class="fas fa-save me-1"></i>Save
            </button>
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          </div>
        </div>
      </form>
    </div>
  </div>
  

<% if (pagination.totalPages > 1) { %>
<nav class="mt-4">
  <ul class="pagination justify-content-center">
    <% for (let i = 1; i <= pagination.totalPages; i++) { %>
    <li class="page-item <%= i === pagination.page ? 'active' : '' %>">
      <a class="page-link" href="#" data-page="<%= i %>"><%= i %></a>
    </li>
    <% } %>
  </ul>
</nav>
<% } %>

<script>
    $(document).on('click', '.update-status-btn', function () {
    console.log('hola')
    const issueId = $(this).data('issue-id');
    const currentStatus = $(this).data('current-status');

    $('#modalIssueId').val(issueId);
    $('#newStatus').val(currentStatus);
    $('#statusComment').val('');
  });
</script>
<!-- jQuery (before Bootstrap) -->
<script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>

<!-- Bootstrap JS (must be included after jQuery) -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

